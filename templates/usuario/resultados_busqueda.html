{% extends 'base.html' %}
{% load static %}

{% block title %}Resultados de búsqueda{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container mt-5">
    <h2>Resultados de búsqueda para "{{ query }}"</h2>
    
    {% if resultados %}
        <div class="list-group">
            {% for resultado in resultados %}
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1">{{ resultado.username }}</h5>
                        {% if resultado.domain %}
                            <small>@{{ resultado.domain }}</small>
                        {% endif %}
                    </div>
                    <div>
                        {% if resultado.username == user.username and resultado.domain == local_domain %}
                            <span class="text-muted">Este eres tú</span>
                        {% else %}
                            {% if resultado.is_following %}
                                <button class="btn btn-outline-primary unfollow-btn" 
                                        data-username="{{ resultado.username }}"
                                        data-domain="{{ resultado.domain|default:'' }}">
                                    Dejar de seguir
                                </button>
                            {% else %}
                                <button class="btn btn-primary follow-btn" 
                                        data-username="{{ resultado.username }}"
                                        data-domain="{{ resultado.domain|default:'' }}">
                                    Seguir
                                </button>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p>No se encontraron resultados.</p>
    {% endif %}
</div>

<script>
function followUser(username, domain, actorUrl) {
    fetch(`/usuario/${username}@${domain}/follow/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            'actor_url': actorUrl,
            'remote_username': username,
            'remote_domain': domain
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();  // Reload to update buttons
        } else {
            alert(data.error || 'Error al seguir al usuario');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al procesar la solicitud');
    });
}

function unfollowUser(username, domain) {
    if (confirm('¿Estás seguro de que quieres dejar de seguir a este usuario?')) {
        fetch(`/usuario/${username}@${domain}/unfollow/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();  // Reload to update buttons
            } else {
                alert(data.error || 'Error al dejar de seguir al usuario');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al procesar la solicitud');
        });
    }
}
</script>
{% endblock %} 